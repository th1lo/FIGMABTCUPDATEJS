<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC Price Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <!-- Update the header section -->
    <header class="bg-gray-900 border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="md:flex md:items-center md:justify-between">
                <div class="min-w-0 flex-1">
                    <h2 class="text-2xl/7 font-bold text-white sm:truncate sm:text-3xl sm:tracking-tight">
                        BTC Price Tracker
                    </h2>
                </div>
                <div class="mt-4 flex md:ml-4 md:mt-0">
                    <button onclick="openModal()" 
                        class="inline-flex items-center rounded-md bg-orange-500 px-3.5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-orange-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-orange-500">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add Configuration
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Update the main content area -->
    <main class="max-w-7xl mx-auto">
        <div class="bg-gray-900 py-10">
            <div class="px-4 sm:px-6 lg:px-8">
                <div class="sm:flex sm:items-center">
                    <div class="sm:flex-auto">
                        <h1 class="text-base font-semibold leading-7 text-white">Configurations</h1>
                        <p class="mt-2 text-sm text-gray-300">A list of all BTC price tracker configurations including their status, update frequency, and latest logs.</p>
                    </div>
                </div>

                <!-- Empty State with updated styling -->
                <div id="emptyState" class="hidden mt-8 text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3 class="mt-2 text-sm font-semibold text-white">No configurations</h3>
                    <p class="mt-1 text-sm text-gray-500">Get started by creating a new configuration.</p>
                    <div class="mt-6">
                        <button onclick="openModal()" 
                            class="inline-flex items-center rounded-md bg-orange-500 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-orange-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-orange-500">
                            <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"/>
                            </svg>
                            New Configuration
                        </button>
                    </div>
                </div>

                <!-- Table with updated styling -->
                <div class="mt-8 flow-root">
                    <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                        <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                            <table id="configTable" class="min-w-full divide-y divide-white/10">
                                <thead>
                                    <tr>
                                        <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-white sm:pl-0">Name</th>
                                        <th scope="col" class="hidden px-3 py-3.5 text-left text-sm font-semibold text-white lg:table-cell">Figma File Key</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-white">Update Frequency</th>
                                        <th scope="col" class="hidden px-3 py-3.5 text-left text-sm font-semibold text-white sm:table-cell">Last Updated</th>
                                        <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-white">Status</th>
                                        <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-0">
                                            <span class="sr-only">Actions</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="configList">
                                    <!-- Configurations will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Update the displayConfigurations function to match the new design -->
    <script>
        function displayConfigurations(configs) {
            // ... existing empty state check ...

            const configList = document.getElementById('configList');
            configList.innerHTML = configs.map(config => {
                const lastUpdated = config.lastUpdated 
                    ? new Intl.RelativeTimeFormat('en', { numeric: 'auto' }).format(
                        -Math.round((Date.now() - new Date(config.lastUpdated).getTime()) / 60000),
                        'minutes'
                      )
                    : 'Never';
                
                const lastLog = config.logs && config.logs.length > 0
                    ? config.logs[config.logs.length - 1]
                    : 'No logs available';

                const statusClass = config.enabled 
                    ? 'text-green-400 bg-green-400/10' 
                    : 'text-rose-400 bg-rose-400/10';

                return `
                    <tr>
                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-white sm:pl-0">
                            ${config.id}
                        </td>
                        <td class="hidden whitespace-nowrap px-3 py-4 text-sm text-gray-300 sm:table-cell">
                            <div class="flex gap-x-3">
                                <div class="font-mono">${config.figmaFileKey}</div>
                            </div>
                        </td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-300">
                            Every ${config.interval} minutes
                        </td>
                        <td class="hidden whitespace-nowrap px-3 py-4 text-sm text-gray-300 md:table-cell">
                            ${lastUpdated}
                        </td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm">
                            <div class="flex items-center gap-x-2">
                                <div class="${statusClass} flex-none rounded-full p-1">
                                    <div class="h-1.5 w-1.5 rounded-full bg-current"></div>
                                </div>
                                <span class="text-white">${config.enabled ? 'Active' : 'Paused'}</span>
                            </div>
                        </td>
                        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-0">
                            <div class="flex justify-end gap-x-3">
                                <button onclick="toggleConfig('${config.id}')" 
                                    class="text-orange-400 hover:text-orange-300">
                                    ${config.enabled ? 'Pause' : 'Start'}
                                </button>
                                <button onclick="editConfig('${config.id}')" 
                                    class="text-gray-400 hover:text-gray-300">
                                    Edit
                                </button>
                                <button onclick="deleteConfig('${config.id}')" 
                                    class="text-rose-400 hover:text-rose-300">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr class="border-t border-white/5 bg-gray-800/40">
                        <td colspan="6" class="px-3 py-4">
                            <div class="text-sm">
                                <strong class="font-medium text-white">Last Update Log:</strong>
                                <pre class="mt-2 text-xs text-gray-300 bg-gray-800/50 p-2 rounded overflow-auto max-h-20 border border-white/10">${lastLog}</pre>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update the updateConfigFile function with better error handling
        async function updateConfigFile(content, sha) {
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/.github/btc-tracker-config.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'  // Add this header
                    },
                    body: JSON.stringify({
                        message: 'Update BTC tracker configuration',
                        content: btoa(JSON.stringify(content, null, 2)),
                        sha: sha
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`GitHub API error: ${response.status} - ${JSON.stringify(errorData)}`);
                }

                return response;
            } catch (error) {
                console.error('Full error details:', error);
                throw error;
            }
        }

        // Add these encryption helper functions
        function encryptToken(token) {
            // Simple base64 encoding for now - in production you'd want stronger encryption
            return btoa(token);
        }

        function decryptToken(encrypted) {
            return atob(encrypted);
        }

        // Update the addConfiguration function to encrypt the Figma token
        async function addConfiguration(config) {
            try {
                if (!githubToken) {
                    throw new Error('Not authenticated');
                }

                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/.github/btc-tracker-config.json`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                let currentContent;
                let sha;

                if (response.status === 404) {
                    currentContent = {
                        configurations: []
                    };
                } else if (response.ok) {
                    const data = await response.json();
                    currentContent = JSON.parse(atob(data.content));
                    sha = data.sha;
                } else {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                currentContent.configurations.push({
                    id: config.name,
                    enabled: true,
                    interval: parseInt(config.interval),
                    figmaFileKey: config.figmaFileKey,
                    figmaToken: encryptToken(config.figmaToken),
                    collectionName: config.collectionName,
                    lastUpdated: new Date().toISOString(),
                    logs: []
                });

                await updateConfigFile(currentContent, sha);
                await loadConfigurations();
            } catch (error) {
                console.error('Error adding configuration:', error);
                alert(`Failed to add configuration: ${error.message}`);
            }
        }

        // Add this near the top of your script
        function showLoading(show) {
            const button = document.querySelector('#configForm button[type="submit"]');
            if (show) {
                button.disabled = true;
                button.textContent = 'Adding...';
            } else {
                button.disabled = false;
                button.textContent = 'Add Configuration';
            }
        }

        // Update the form submission handler
        document.getElementById('configForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            try {
                const formData = {
                    name: document.getElementById('configName').value,
                    figmaFileKey: document.getElementById('figmaFileKey').value,
                    figmaToken: document.getElementById('figmaToken').value,
                    collectionName: document.getElementById('collectionName').value,
                    interval: document.getElementById('interval').value
                };
                await addConfiguration(formData);
                e.target.reset();
            } catch (error) {
                console.error('Form submission error:', error);
                alert(`Failed to submit form: ${error.message}`);
            } finally {
                showLoading(false);
            }
        });

        // Initialize
        checkAuth();

        // Add these functions:
        async function toggleConfig(configId) {
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/.github/btc-tracker-config.json`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                const data = await response.json();
                const currentContent = JSON.parse(atob(data.content));
                
                const config = currentContent.configurations.find(c => c.id === configId);
                if (config) {
                    config.enabled = !config.enabled;
                    await updateConfigFile(currentContent, data.sha);
                    loadConfigurations();
                }
            } catch (error) {
                console.error('Error toggling configuration:', error);
            }
        }

        async function deleteConfig(configId) {
            if (!confirm('Are you sure you want to delete this configuration?')) return;
            
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/.github/btc-tracker-config.json`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                const data = await response.json();
                const currentContent = JSON.parse(atob(data.content));
                
                currentContent.configurations = currentContent.configurations.filter(c => c.id !== configId);
                await updateConfigFile(currentContent, data.sha);
                loadConfigurations();
            } catch (error) {
                console.error('Error deleting configuration:', error);
            }
        }

        // Modal functions
        function openModal() {
            document.getElementById('configModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('configModal').classList.add('hidden');
            document.getElementById('configForm').reset();
            document.getElementById('configForm').dataset.editId = '';
            document.querySelector('#configModal h3').textContent = 'Add New Configuration';
            document.querySelector('#configModal button[onclick="submitForm()"]').textContent = 'Save Configuration';
        }

        async function submitForm() {
            const form = document.getElementById('configForm');
            if (form.checkValidity()) {
                const formData = {
                    name: document.getElementById('configName').value,
                    figmaFileKey: document.getElementById('figmaFileKey').value,
                    figmaToken: document.getElementById('figmaToken').value,
                    collectionName: document.getElementById('collectionName').value,
                    interval: document.getElementById('interval').value
                };

                const editId = form.dataset.editId;
                if (editId) {
                    // Update existing configuration
                    await updateConfiguration(editId, formData);
                } else {
                    // Add new configuration
                    await addConfiguration(formData);
                }
                
                closeModal();
            } else {
                form.reportValidity();
            }
        }

        // Add this new function for editing configurations
        async function editConfig(configId) {
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/.github/btc-tracker-config.json`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                const data = await response.json();
                const currentContent = JSON.parse(atob(data.content));
                
                const config = currentContent.configurations.find(c => c.id === configId);
                if (config) {
                    // Populate the form with existing values
                    document.getElementById('configName').value = config.id;
                    document.getElementById('figmaFileKey').value = config.figmaFileKey;
                    document.getElementById('figmaToken').value = decryptToken(config.figmaToken);
                    document.getElementById('collectionName').value = config.collectionName;
                    document.getElementById('interval').value = config.interval;
                    
                    // Store the original config ID for updating
                    document.getElementById('configForm').dataset.editId = configId;
                    
                    // Update modal title and button
                    document.querySelector('#configModal h3').textContent = 'Edit Configuration';
                    document.querySelector('#configModal button[onclick="submitForm()"]').textContent = 'Update Configuration';
                    
                    openModal();
                }
            } catch (error) {
                console.error('Error loading configuration for edit:', error);
                alert('Failed to load configuration for editing');
            }
        }

        // Add this new function for updating configurations
        async function updateConfiguration(editId, config) {
            try {
                if (!githubToken) {
                    throw new Error('Not authenticated');
                }

                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/.github/btc-tracker-config.json`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                const data = await response.json();
                const currentContent = JSON.parse(atob(data.content));
                
                // Find and update the existing configuration
                const configIndex = currentContent.configurations.findIndex(c => c.id === editId);
                if (configIndex !== -1) {
                    currentContent.configurations[configIndex] = {
                        id: config.name,
                        enabled: currentContent.configurations[configIndex].enabled,
                        interval: parseInt(config.interval),
                        figmaFileKey: config.figmaFileKey,
                        figmaToken: encryptToken(config.figmaToken),
                        collectionName: config.collectionName,
                        lastUpdated: new Date().toISOString(),
                        logs: currentContent.configurations[configIndex].logs || []
                    };

                    await updateConfigFile(currentContent, data.sha);
                    await loadConfigurations();
                }
            } catch (error) {
                console.error('Error updating configuration:', error);
                alert(`Failed to update configuration: ${error.message}`);
            }
        }
    </script>
</body>
</html> 